{% extends "base.html" %}
{% block title %}Calendario de citas{% endblock %}

{% block content %}
<div class="card">
    <h1>Calendario de citas</h1>
    <p class="form-sub">
        Vista general de todas las citas registradas, organizadas por día y con filtro por nivel de urgencia.
    </p>

    <div class="calendar-toolbar">
        <div class="calendar-summary">
            <span class="calendar-total">Total de citas: <strong>{{ total_citas }}</strong></span>
        </div>
        <div class="calendar-filters">
            <a href="{{ url_for('citas') }}"
               class="urg-filter-chip {% if urgencia_actual == 'todas' %}active{% endif %}">
                Todas
            </a>
            <a href="{{ url_for('citas', urg='alta') }}"
               class="urg-filter-chip urg-alta-chip {% if urgencia_actual == 'alta' %}active{% endif %}">
                Urgencias altas ({{ counts['alta'] }})
            </a>
            <a href="{{ url_for('citas', urg='media') }}"
               class="urg-filter-chip urg-media-chip {% if urgencia_actual == 'media' %}active{% endif %}">
                Urgencias medias ({{ counts['media'] }})
            </a>
            <a href="{{ url_for('citas', urg='baja') }}"
               class="urg-filter-chip urg-baja-chip {% if urgencia_actual == 'baja' %}active{% endif %}">
                Urgencias bajas ({{ counts['baja'] }})
            </a>
        </div>
    </div>

    {% if grupos %}
        <div class="calendar-groups">
            {% for g in grupos %}
            <section class="calendar-day-card">
                <header class="calendar-day-header">
                    <h2>{{ g.fecha_label }}</h2>
                    <span class="calendar-day-count">
                        {{ g['items']|length }} cita{{ 's' if g['items']|length != 1 }}
                    </span>
                </header>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Mascota</th>
                            <th>Responsable</th>
                            <th>Veterinario</th>
                            <th>Servicio</th>
                            <th>Urgencia</th>
                            <th>Síntomas</th>
                            <th style="text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in g['items'] %}
                        {% set urg = (c['urgencia'] or '').lower() %}
                        <tr>
                            {% set dt = c['fecha_hora'] %}
                            <td>{{ dt[11:16] }}</td>
                            <td>{{ c['mascota'] }} <span class="badge-mini">{{ c['tipo_mascota'] }}</span></td>
                            <td>{{ c['dueno'] }}</td>
                            <td>{{ c['vet'] }}</td>
                            <td>{{ c['tipo_servicio'] }}</td>
                            <td class="urg-cell">
                                {% if urg == 'alta' %}
                                    <span class="urg-tag urg-alta">ALTA</span>
                                {% elif urg == 'media' %}
                                    <span class="urg-tag urg-media">MEDIA</span>
                                {% elif urg == 'baja' %}
                                    <span class="urg-tag urg-baja">BAJA</span>
                                {% else %}
                                    <span class="urg-tag">N/A</span>
                                {% endif %}
                            </td>
                            <td class="symptoms-cell">
                                {% if c['sintomas'] %}
                                    {% if c['sintomas']|length > 60 %}
                                        {{ c['sintomas'][:60] }}…
                                    {% else %}
                                        {{ c['sintomas'] }}
                                    {% endif %}
                                {% else %}
                                    <span class="symptoms-empty">Sin descripción</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <a class="link-button"
                                   href="{{ url_for('cita_detalle', cita_id=c['id']) }}">
                                    Ver
                                </a>
                                <a class="link-button"
                                   href="{{ url_for('cita_editar', cita_id=c['id']) }}">
                                    Editar
                                </a>
                                <form action="{{ url_for('cita_eliminar', cita_id=c['id']) }}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('¿Seguro que deseas eliminar esta cita?');">
                                    <button type="submit" class="link-button link-danger">
                                        Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
            {% endfor %}
        </div>
    {% else %}
        <p>No hay citas registradas.</p>
    {% endif %}
</div>
{% endblock %}
